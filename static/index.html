<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Face Feature Detection</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center justify-center p-4">
  <h1 class="text-3xl font-bold text-gray-800 mb-4">👤 Face Feature Detection</h1>
  <p class="text-gray-600 mb-4">Fix your face in the camera and click the button to capture</p>

  <video id="video" class="rounded-lg border border-gray-300 shadow-lg w-[500px]" autoplay></video>

  <button id="captureBtn"
    class="mt-4 px-6 py-2 bg-blue-600 text-white font-semibold rounded hover:bg-blue-700 transition">
    📸 Capture & Detect
  </button>

  <div id="spinner" class="hidden mt-4">
    <svg class="animate-spin h-10 w-10 text-blue-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none"
      viewBox="0 0 24 24">
      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
        stroke-width="4"></circle>
      <path class="opacity-75" fill="currentColor"
        d="M4 12a8 8 0 018-8v8H4z"></path>
    </svg>
    <p class="text-blue-600 mt-2">Detecting...</p>
  </div>

  <h2 class="mt-6 text-lg font-medium text-gray-700">Detection Result</h2>
  <img id="outputImg" class="mt-2 rounded-lg border shadow-lg w-[500px]" />
  <a id="downloadBtn"
    class="hidden mt-4 px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition"
    download="detected.jpg">⬇️ Download Result</a>

  <script>
    const video = document.getElementById("video");
    const captureBtn = document.getElementById("captureBtn");
    const outputImg = document.getElementById("outputImg");
    const spinner = document.getElementById("spinner");
    const downloadBtn = document.getElementById("downloadBtn");

    const ws = new WebSocket("ws://localhost:8000/ws");

    // Start webcam
    navigator.mediaDevices.getUserMedia({ video: true }).then(stream => {
      video.srcObject = stream;
    }).catch(err => {
      alert("Failed to access camera: " + err);
    });

    // WebSocket response
    ws.onmessage = (event) => {
      const base64Image = event.data;
      outputImg.src = 'data:image/jpeg;base64,' + base64Image;
      outputImg.onload = () => {
        spinner.classList.add("hidden");
        downloadBtn.href = outputImg.src;
        downloadBtn.classList.remove("hidden");
      };
    };

    // Capture button logic
    captureBtn.onclick = () => {
      spinner.classList.remove("hidden");
      downloadBtn.classList.add("hidden");

      const canvas = document.createElement("canvas");
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

      // Re-show video feed after capture (avoids black screen)
      requestAnimationFrame(() => {
        video.play();
      });

      const base64Image = canvas.toDataURL("image/jpeg").split(",")[1];
      ws.send(base64Image);
    };
  </script>
</body>
</html>
